name: '[Deploy] Deploy, Sync and Test Applications'
run-name: >
  ${{ format('{0}Deploying to {1} — FE:{2} BE:{3}',
    github.event.client_payload.pr_number && format('PR #{0} ', github.event.client_payload.pr_number) || '',
    github.event.client_payload.target_env || inputs.target_env,
    github.event.client_payload.fe_tag_name || inputs.fe_tag_name,
    github.event.client_payload.be_tag_name || inputs.be_tag_name
  ) }}  
  
on:
  repository_dispatch:
    types: 
      - Trigger-Deploy-Sync-Test
      - Trigger-DeployFE-Sync-Test
      - Trigger-DeployBE-Sync-Test

  workflow_dispatch:
    inputs:
     fe_deploy:
       description: 'Deploy Frontend (Angular)'
       required: true
       type: boolean
       default: false
     fe_tag_name:
       required: true
       description: 'Tag to deploy (Frontend)'
       type: string
       default: 'latest'
     be_deploy:
       description: 'Deploy Backend (Spring Boot)'
       required: true
       type: boolean
       default: false
     be_tag_name:
       required: true
       description: 'Tag to deploy (Backend)'
       type: string
       default: 'latest'
     target_env:
       required: true
       description: 'Target Environment'
       type: choice
       options:
         - stage
         - prod
     auth0_sync:
       description: 'Sync Environments'
       required: true
       type: boolean
       default: false
     run_smoke_test:
       description: 'Run Smoke Test'
       required: true
       type: boolean
       default: true
     log_level:
       description: 'Backend Log Level (only for stage environment)'
       required: false
       type: choice
       default: WARN
       options:
         - DEBUG
         - INFO
         - WARN
         - ERROR
jobs:
  set_env:
    name: 'SetUp Environment'
    uses: nabarun-ngo/ngo-nabarun-templates/.github/workflows/Setup-Env.yml@main
    with:
      inputs: ${{ toJson(inputs) }}
      client_payload: ${{ toJson(github.event.client_payload) }}
      script_path: scripts/set_latest_tag.sh
      resolve_variables: 'fe_tag_name,be_tag_name'
     
  firebase_deploy:
    if: ${{ fromJson(needs.set_env.outputs.variables).fe_deploy }}
    needs: set_env
    name: Deploy to Firebase
    uses: nabarun-ngo/ngo-nabarun-templates/.github/workflows/Deploy-Firebase.yml@main
    with:
     tag_name: ${{ fromJson(needs.set_env.outputs.variables).fe_tag_name }}
     repo_name: 'ngo-nabarun-fe'
     repo_owner_name: 'nabarun-ngo'
     environment_name: ${{ fromJson(needs.set_env.outputs.variables).target_env }}
     npm_run_command: ${{ fromJson(needs.set_env.outputs.variables).target_env == 'prod' && 'npm ci --legacy-peer-deps && npm run build' || 'npm ci --legacy-peer-deps && npm run build:stage' }}
    secrets:
      firebase_project_id: ${{ secrets.FB_PROJECT_ID }}
      firebase_service_account: ${{ secrets.FB_SA_KEY }}
      repo_token: ${{ secrets.PAT }}
  
  gcp_deploy:
    if: ${{ fromJson(needs.set_env.outputs.variables).be_deploy }}
    needs: set_env
    name: Deploy to GCP App Engine 
    uses: nabarun-ngo/ngo-nabarun-templates/.github/workflows/Deploy-GCP-v2.yml@main
    with:
     tag_name: ${{ fromJson(needs.set_env.outputs.variables).be_tag_name }}
     repo_name: 'ngo-nabarun-be'
     repo_owner_name: 'nabarun-ngo'
     environment_name: ${{ fromJson(needs.set_env.outputs.variables).target_env }}
     target_folder: 'ngo-nabarun-app/target'
     app_env: ${{ fromJson(needs.set_env.outputs.variables).target_env == 'prod' && 'prod' || 'stage' }}
     app_doppler_project_name: 'nabarun_backend' 
     app_log_level: ${{ fromJson(needs.set_env.outputs.variables).target_env == 'prod' && 'ERROR' || fromJson(needs.set_env.outputs.variables).log_level || 'WARN' }}
    secrets:
      gcp_project_id: ${{ secrets.GCP_PROJECT_ID }}
      gcp_service_account: ${{ secrets.GCP_SA_KEY }}
      app_doppler_service_token: ${{ secrets.DOPPLER_TOKEN_NABARUN_BACKEND }}
      repo_token: ${{ secrets.PAT }}

  sync_data:
      # always Running this data sync for prod deployment
      if: ${{ fromJson(needs.set_env.outputs.variables).auth0_sync || fromJson(needs.set_env.outputs.variables).target_env == 'prod' }}
      needs: set_env
      name: Trigger Sync Auth0 & Firebase
      uses: nabarun-ngo/ngo-nabarun-templates/.github/workflows/Trigger-Workflow.yml@main    
      with:
        repository: 'nabarun-ngo/ngo-nabarun-ops'
        event_type: Trigger-Import-Sync-Data
        input_json: |-
            {
                "auth0_sync_tenant": true,
                "auth0_source_tenant": "${{ fromJson(needs.set_env.outputs.variables).target_env == 'prod' && 'STAGE' || 'DEV' }}",
                "auth0_dest_tenant": "${{ fromJson(needs.set_env.outputs.variables).target_env == 'prod' && 'PROD' || 'STAGE' }}",
                "firebase_sync_rc" : ${{ fromJson(needs.set_env.outputs.variables).target_env == 'prod' }},
                "firebase_source_env" : "STAGE",
                "firebase_dest_env" : "PROD"
            } 
      secrets:
        token: ${{ secrets.GITHUB_TOKEN }} 

  
  trigger_smoke_test:
    name: 'Trigger Smoke Test'
    if: ${{ fromJson(needs.set_env.outputs.variables).run_smoke_test && (needs.firebase_deploy.result == 'success' || needs.gcp_deploy.result == 'success') && always() }}
    needs: [set_env,firebase_deploy,gcp_deploy]
    uses: nabarun-ngo/ngo-nabarun-templates/.github/workflows/Trigger-Workflow.yml@main    
    with:
        repository: ${{ fromJson(needs.set_env.outputs.variables).target_env == 'prod' && 'nabarun-ngo/ngo-nabarun-prodops' || 'nabarun-ngo/ngo-nabarun-ops' }}
        event_type: Trigger-Smoke-Test
        input_json: |-
            {
                "test_env": "${{ fromJson(needs.set_env.outputs.variables).target_env }}",
                "test_type": "Smoke",
                "fe_tag_name": "${{ fromJson(needs.set_env.outputs.variables).fe_tag_name }}",
                "be_tag_name": "${{ fromJson(needs.set_env.outputs.variables).be_tag_name }}",
                "test_filter_tag_smoke": "${{ fromJson(needs.set_env.outputs.variables).target_env == 'prod' && '@smokeprod' || '@smoke' }}",
                "cancel_running_test": ${{ !(fromJson(needs.set_env.outputs.variables).fe_deploy && fromJson(needs.set_env.outputs.variables).be_deploy) }}
            }
    secrets:
        token: ${{ secrets.GITHUB_TOKEN }}

  deployment_summary:
    name: '📊 Deployment Summary'
    runs-on: ubuntu-latest
    needs: [set_env, firebase_deploy, gcp_deploy, sync_data, trigger_smoke_test]
    if: always()
    steps:
      - name: 📋 Generate Deployment Report
        id: summary
        run: |
          echo "## 🚀 Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🎯 Target Environment: ${{ fromJson(needs.set_env.outputs.variables).target_env }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📦 Versions" >> $GITHUB_STEP_SUMMARY
          echo "- 🖥️ Frontend: ${{ fromJson(needs.set_env.outputs.variables).fe_tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- 🔧 Backend: ${{ fromJson(needs.set_env.outputs.variables).be_tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### 🚀 Deployment Status" >> $GITHUB_STEP_SUMMARY
          
          # Frontend status
          if [[ "${{ fromJson(needs.set_env.outputs.variables).fe_deploy }}" == "true" ]]; then
            if [[ "${{ needs.firebase_deploy.result }}" == "success" ]]; then
              echo "- ✅ **Firebase Frontend**: Successfully deployed ${{ fromJson(needs.set_env.outputs.variables).fe_tag_name }}" >> $GITHUB_STEP_SUMMARY
            elif [[ "${{ needs.firebase_deploy.result }}" == "skipped" ]]; then
              echo "- ⏭️ **Firebase Frontend**: Deployment skipped" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ❌ **Firebase Frontend**: Deployment failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- ⏭️ **Firebase Frontend**: Not selected for deployment" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Backend status
          if [[ "${{ fromJson(needs.set_env.outputs.variables).be_deploy }}" == "true" ]]; then
            if [[ "${{ needs.gcp_deploy.result }}" == "success" ]]; then
              echo "- ✅ **GCP Backend**: Successfully deployed ${{ fromJson(needs.set_env.outputs.variables).be_tag_name }} with log level ${{ fromJson(needs.set_env.outputs.variables).target_env == 'prod' && 'ERROR' || fromJson(needs.set_env.outputs.variables).log_level || 'WARN' }}" >> $GITHUB_STEP_SUMMARY
            elif [[ "${{ needs.gcp_deploy.result }}" == "skipped" ]]; then
              echo "- ⏭️ **GCP Backend**: Deployment skipped" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ❌ **GCP Backend**: Deployment failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- ⏭️ **GCP Backend**: Not selected for deployment" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Data sync status
          if [[ "${{ fromJson(needs.set_env.outputs.variables).auth0_sync || fromJson(needs.set_env.outputs.variables).target_env == 'prod' }}" == "true" ]]; then
            if [[ "${{ needs.sync_data.result }}" == "success" ]]; then
              echo "- ✅ **Data Sync**: Successfully triggered data synchronization" >> $GITHUB_STEP_SUMMARY
              echo "  - Auth0: ${{ fromJson(needs.set_env.outputs.variables).target_env == 'prod' && 'STAGE to PROD' || 'DEV to STAGE' }}" >> $GITHUB_STEP_SUMMARY
              if [[ "${{ fromJson(needs.set_env.outputs.variables).target_env }}" == "prod" ]]; then
                echo "  - Firebase: STAGE to PROD" >> $GITHUB_STEP_SUMMARY
              fi
            elif [[ "${{ needs.sync_data.result }}" == "skipped" ]]; then
              echo "- ⏭️ **Data Sync**: Synchronization trigger skipped" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ❌ **Data Sync**: Synchronization trigger failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- ⏭️ **Data Sync**: Not selected for synchronization" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Smoke Test status
          if [[ "${{ fromJson(needs.set_env.outputs.variables).run_smoke_test }}" == "true" ]]; then
            if [[ "${{ needs.trigger_smoke_test.result }}" == "success" ]]; then
              echo "- ✅ **Smoke Test**: Successfully triggered" >> $GITHUB_STEP_SUMMARY
              echo "  - Test Environment: ${{ fromJson(needs.set_env.outputs.variables).target_env }}" >> $GITHUB_STEP_SUMMARY
              echo "  - Test Tags: ${{ fromJson(needs.set_env.outputs.variables).target_env == 'prod' && '@smokeprod' || '@smoke' }}" >> $GITHUB_STEP_SUMMARY
            elif [[ "${{ needs.trigger_smoke_test.result }}" == "skipped" ]]; then
              echo "- ⏭️ **Smoke Test**: Test trigger skipped" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ❌ **Smoke Test**: Failed to trigger tests" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- ⏭️ **Smoke Test**: Not selected for execution" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📝 Deployment Notes" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- Run ID: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          
          # Overall status determination
          if [[ ("${{ fromJson(needs.set_env.outputs.variables).fe_deploy }}" == "true" && "${{ needs.firebase_deploy.result }}" != "success") || 
                ("${{ fromJson(needs.set_env.outputs.variables).be_deploy }}" == "true" && "${{ needs.gcp_deploy.result }}" != "success") || 
                ("${{ fromJson(needs.set_env.outputs.variables).auth0_sync || fromJson(needs.set_env.outputs.variables).target_env == 'prod' }}" == "true" && "${{ needs.sync_data.result }}" != "success") || 
                ("${{ fromJson(needs.set_env.outputs.variables).run_smoke_test }}" == "true" && "${{ needs.trigger_smoke_test.result }}" != "success") ]]; then
            echo "\n❗ **Warning**: One or more deployment steps failed or were skipped. Review logs for details." >> $GITHUB_STEP_SUMMARY
          else
            echo "\n✅ **Success**: All selected deployment operations completed successfully." >> $GITHUB_STEP_SUMMARY
          fi
              

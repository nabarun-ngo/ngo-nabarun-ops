name: '[Deploy] Deploy Applications'
run-name: >
  ${{ format('{0}Deploying to {1} â€” FE:{2} BE:{3}',
    github.event.client_payload.pr_number && format('PR #{0} ', github.event.client_payload.pr_number) || '',
    github.event.client_payload.target_env || inputs.target_env,
    github.event.client_payload.fe_tag_name || inputs.fe_tag_name,
    github.event.client_payload.be_tag_name || inputs.be_tag_name
  ) }}  
  
on:
  workflow_dispatch:
    inputs:
     fe_deploy:
       description: 'Deploy Frontend (Angular)'
       required: true
       type: boolean
       default: false
     fe_deploy_public:
       description: 'Deploy Public Frontend (NextJS)'
       required: true
       type: boolean
       default: false
     fe_tag_name:
       required: true
       description: 'Tag to deploy (Frontend)'
       type: string
       default: ''
     be_deploy:
       description: 'Deploy Backend (Spring Boot)'
       required: true
       type: boolean
       default: false
     be_deploy_v2:
       description: 'Deploy Backend (NestJS)'
       required: true
       type: boolean
       default: false
     be_tag_name:
       required: true
       description: 'Tag to deploy (Backend)'
       type: string
       default: ''
     target_env:
       required: true
       description: 'Target Environment'
       type: choice
       options:
         - stage
         - prod
     auth0_sync:
       description: 'Sync Environments'
       required: true
       type: boolean
       default: false
     run_smoke_test:
       description: 'Run Smoke Test'
       required: true
       type: boolean
       default: true
     log_level:
       description: 'Backend Log Level (only for stage environment)'
       required: false
       type: choice
       default: WARN
       options:
         - DEBUG
         - INFO
         - WARN
         - ERROR
jobs:
  set_env:
    name: 'SetUp Environment'
    uses: nabarun-ngo/ngo-nabarun-templates/.github/workflows/Setup-Env.yml@main
    with:
      inputs: ${{ toJson(inputs) }}
      client_payload: ${{ toJson(github.event.client_payload) }}
      #script_path: scripts/set_latest_tag.sh
      #resolve_variables: 'fe_tag_name,be_tag_name'
     
  firebase_deploy:
    if: ${{ fromJson(needs.set_env.outputs.variables).fe_deploy }}
    needs: set_env
    name: Deploy to Firebase
    uses: nabarun-ngo/ngo-nabarun-templates/.github/workflows/Deploy-Firebase.yml@main
    with:
     tag_name: ${{ fromJson(needs.set_env.outputs.variables).fe_tag_name }}
     repo_name: 'ngo-nabarun-fe'
     repo_owner_name: 'nabarun-ngo'
     environment_name: ${{ fromJson(needs.set_env.outputs.variables).target_env }}
     npm_run_command: ${{ fromJson(needs.set_env.outputs.variables).target_env == 'prod' && 'npm ci --legacy-peer-deps && npm run build' || 'npm ci --legacy-peer-deps && npm run build:stage' }}
     target_site: ${{ fromJson(needs.set_env.outputs.variables).target_env == 'prod' && 'ngonabarun-portal' || 'ngonabarun-portal-stage' }}
    secrets:
      firebase_project_id: ${{ secrets.FB_PROJECT_ID }}
      firebase_service_account: ${{ secrets.FB_SA_KEY }}
      repo_token: ${{ secrets.PAT }}

  redis_delete:
    name: 'Clean Redis Cache'
    if: ${{ fromJson(needs.set_env.outputs.variables).fe_deploy_public }}
    needs: set_env
    uses: nabarun-ngo/ngo-nabarun-templates/.github/workflows/Redis-Ops.yml@main
    with:
      operation: 'delete-keys'
      environment: ${{ fromJson(needs.set_env.outputs.variables).target_env}}
      key: 'REMOTE_CONFIG_PARAMS'
    secrets:
      redis_host: ${{ secrets.REDIS_HOST }}
      redis_port: ${{ secrets.REDIS_PORT }}
      redis_password: ${{ secrets.REDIS_PASSWORD }}
      
  firebase_deploy_public:
    if: ${{ fromJson(needs.set_env.outputs.variables).fe_deploy_public }}
    needs: [set_env,redis_delete]
    name: Deploy to Firebase (Public Site)
    uses: nabarun-ngo/ngo-nabarun-templates/.github/workflows/Deploy-Firebase.yml@main
    with:
     tag_name: ${{ fromJson(needs.set_env.outputs.variables).fe_tag_name }}
     repo_name: 'ngo-nabarun-public'
     repo_owner_name: 'nabarun-ngo'
     environment_name: ${{ fromJson(needs.set_env.outputs.variables).target_env }}
     npm_run_command: 'npm install && npm run build'
     target_site: ${{ fromJson(needs.set_env.outputs.variables).target_env == 'prod' && 'ngonabarun' || 'ngonabarun-stage' }}
     use_doppler: true
     build_output_dir: 'out'
     doppler_project: 'nabarun_backend'
     doppler_config: ${{ fromJson(needs.set_env.outputs.variables).target_env == 'prod' && 'prod_nest' || 'stage_nest' }}
    secrets:
      firebase_project_id: ${{ secrets.FB_PROJECT_ID }}
      firebase_service_account: ${{ secrets.FB_SA_KEY }}
      repo_token: ${{ secrets.PAT }}
      doppler_token: ${{ secrets.DOPPLER_TOKEN_NABARUN_BACKEND_NEST }}
  
  gcp_deploy:
    if: ${{ fromJson(needs.set_env.outputs.variables).be_deploy }}
    needs: set_env
    name: Deploy to GCP App Engine 
    uses: nabarun-ngo/ngo-nabarun-templates/.github/workflows/Deploy-GCP-v2.yml@main
    with:
     app_type: 'java'
     tag_name: ${{ fromJson(needs.set_env.outputs.variables).be_tag_name }}
     repo_name: 'ngo-nabarun-be'
     repo_owner_name: 'nabarun-ngo'
     environment_name: ${{ fromJson(needs.set_env.outputs.variables).target_env }}
     target_folder: 'ngo-nabarun-app/target'
     app_doppler_config: ${{ fromJson(needs.set_env.outputs.variables).target_env == 'prod' && 'prod' || 'stage' }}
     app_doppler_project_name: 'nabarun_backend' 
     app_log_level: ${{ fromJson(needs.set_env.outputs.variables).target_env == 'prod' && 'ERROR' || fromJson(needs.set_env.outputs.variables).log_level || 'WARN' }}
    secrets:
      gcp_project_id: ${{ secrets.GCP_PROJECT_ID }}
      gcp_service_account: ${{ secrets.GCP_SA_KEY }}
      app_doppler_service_token: ${{ secrets.DOPPLER_TOKEN_NABARUN_BACKEND }}
      repo_token: ${{ secrets.PAT }}
  ## Disabling gcr for now
  # gcp_cr_deploy:
  #   if: ${{ fromJson(needs.set_env.outputs.variables).be_deploy_v2 }}
  #   needs: set_env
  #   name: Deploy to GCP Cloud Run
  #   uses: nabarun-ngo/ngo-nabarun-templates/.github/workflows/Deploy-GCP-CloudRun.yml@main
  #   with:
  #    tag_name: ${{ fromJson(needs.set_env.outputs.variables).be_tag_name }}
  #    repo_name: 'ngo-nabarun-be-nestjs'
  #    repo_owner_name: 'nabarun-ngo'
  #    environment_name: ${{ fromJson(needs.set_env.outputs.variables).target_env  == 'prod' && 'prod' || 'stage' }}
  #    service_name: 'nabarun-be-nest'
  #    doppler_project: 'nabarun_backend' 
  #    image_name: 'ngonabarun/nabarun-be'
  #    doppler_config: ${{ fromJson(needs.set_env.outputs.variables).target_env == 'prod' && 'prod_nest' || 'stage_nest' }}
  #    enable_health_check: true
  #    health_check_path: '/api/health'
  #   secrets:
  #     GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  #     GCP_SA_KEY: ${{ secrets.GCP_SA_KEY_CR }}
  #     DOPPLER_TOKEN : ${{ secrets.DOPPLER_TOKEN_NABARUN_BACKEND_NEST }}
  #     REPO_TOKEN: ${{ secrets.PAT }}
  #     DOCKER_USER: ${{ secrets.DOCKER_USER }}
  #     DOCKER_TOKEN: ${{ secrets.DOCKER_APIKEY }}


  gcp_gae_deploy:
    if: ${{ fromJson(needs.set_env.outputs.variables).be_deploy_v2 }}
    needs: set_env
    name: Deploy to GCP App Engine (Node)
    uses: nabarun-ngo/ngo-nabarun-templates/.github/workflows/Deploy-GCP-v2.yml@main
    with:
      # Application Configuration
      app_type: 'node'
      tag_name: ${{ fromJson(needs.set_env.outputs.variables).be_tag_name }}
      repo_name: 'ngo-nabarun-be-nestjs'
      repo_owner_name: 'nabarun-ngo'
      environment_name: ${{ fromJson(needs.set_env.outputs.variables).target_env  == 'prod' && 'prod' || 'stage' }}
      #environment_url: 'https://your-node-app.appspot.com'
      gae_service_name: 'api'
      gae_app_yaml_path:  ${{ fromJson(needs.set_env.outputs.variables).target_env  == 'prod' && 'app.prod.yaml' || 'app.yaml' }}
      # Node-specific Configuration
      artifact_pattern: 'dist'  # or 'build' depending on your setup
      prod_only_dependencies: true  # Install only production deps for deployment
      include_node_modules: true    # Include node_modules in deployment
      install_doppler_cli: true     # Install Doppler CLI for runtime secrets/migrations
      
      # Database Migration
      enable_db_migration: true
      migration_command: 'npm ci && npx prisma migrate deploy'
          
      # Environment Configuration
      app_doppler_config: ${{ fromJson(needs.set_env.outputs.variables).target_env  == 'prod' && 'prod_nest' || 'stage_nest' }}
      app_doppler_project_name: 'nabarun_backend'
      app_log_level: 'INFO'
      
      # Deployment Configuration
      enable_health_check: false
      enable_cache: true
      
      # Cleanup Configuration
      keep_gae_versions: 1
      gcs_keep_days: 1
      
    secrets:
      gcp_project_id: ${{ secrets.GCP_PROJECT_ID }}
      gcp_service_account: ${{ secrets.GCP_SA_KEY  }}
      app_doppler_service_token: ${{ secrets.DOPPLER_TOKEN_NABARUN_BACKEND_NEST }}
      repo_token: ${{ secrets.PAT }}


  sync_data:
      # always Running this data sync for prod deployment
      if: ${{ fromJson(needs.set_env.outputs.variables).auth0_sync || fromJson(needs.set_env.outputs.variables).target_env == 'prod' }}
      needs: set_env
      name: Trigger Sync Auth0 & Firebase
      uses: nabarun-ngo/ngo-nabarun-templates/.github/workflows/Trigger-Workflow.yml@main    
      with:
        repository: 'nabarun-ngo/ngo-nabarun-ops'
        event_type: Trigger-Import-Sync-Data
        input_json: |-
            {
                "auth0_sync_tenant": true,
                "auth0_source_tenant": "${{ fromJson(needs.set_env.outputs.variables).target_env == 'prod' && 'STAGE' || 'DEV' }}",
                "auth0_dest_tenant": "${{ fromJson(needs.set_env.outputs.variables).target_env == 'prod' && 'PROD' || 'STAGE' }}",
                "firebase_sync_rc" : ${{ fromJson(needs.set_env.outputs.variables).target_env == 'prod' }},
                "firebase_source_env" : "STAGE",
                "firebase_dest_env" : "PROD"
            } 
      secrets:
        token: ${{ secrets.GITHUB_TOKEN }} 

  #needs.gcp_cr_deploy.result == 'success' ||
  trigger_smoke_test:
    name: 'Trigger Smoke Test'
    if: |
      needs.set_env.result == 'success' && 
      fromJson(needs.set_env.outputs.variables).run_smoke_test && 
      ( needs.firebase_deploy.result == 'success')
    needs: [set_env, firebase_deploy]
    uses: nabarun-ngo/ngo-nabarun-templates/.github/workflows/Trigger-Workflow.yml@main
    with:
      repository: 'nabarun-ngo/ngo-nabarun-ops'
      event_type: Trigger-Smoke-Test
      input_json: |-
        {
          "test_env": "${{ fromJson(needs.set_env.outputs.variables).target_env }}",
          "test_type": "Smoke",
          "fe_tag_name": "${{ fromJson(needs.set_env.outputs.variables).fe_tag_name }}",
          "be_tag_name": "${{ fromJson(needs.set_env.outputs.variables).be_tag_name }}",
          "test_filter_tag_smoke": "${{ fromJson(needs.set_env.outputs.variables).target_env == 'prod' && '@smokeprod' || '@smoke' }}",
          "cancel_running_test": ${{ !(fromJson(needs.set_env.outputs.variables).fe_deploy && fromJson(needs.set_env.outputs.variables).be_deploy_v2) }}
        }
    secrets:
      token: ${{ secrets.GITHUB_TOKEN }}
               
   

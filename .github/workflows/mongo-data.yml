name: '[Util] MongoDB Data Operations'
on:
  workflow_dispatch:
    inputs:
     action:
        description: "Data Operation"
        required: true
        type: choice
        options:
          - import
          - migrate
     target_env:
        description: 'Target Environment'  
        required: true
        type: choice
        options:
          - stage
          - prod
     script-path:
        description: "Relative path to the MongoDB script (.js)"
        required: false
        default: './scripts/mongodb/  .js'
        type: string
     import-file:
        description: "Path to JSON file to import"
        required: false
        default: './data/mongodb/  .json'
        type: string
     import-collection:
        description: "Target collection for import"
        required: false
        default: ''
        type: string
     migration-script:
        description: "Script path"
        required: false
        default: './scripts/migrate/  .js'
        type: string
     

jobs:
  set_env:
    name: 'Setup Inputs'
    uses: nabarun-ngo/ngo-nabarun-templates/.github/workflows/Setup-Env.yml@main
    with:
      inputs: ${{ toJson(inputs) }}
      client_payload: ${{ toJson(github.event.client_payload) }}

  mongo_data:
    name: 'Mongo Data Ops'
    needs: set_env
    uses: nabarun-ngo/ngo-nabarun-templates/.github/workflows/mongo-cloud.yml@main
    if: ${{ fromJson(needs.set_env.outputs.variables).action == 'import' }}
    with:
      target-env: ${{ fromJson(needs.set_env.outputs.variables).target_env }}
      script-path: ${{ fromJson(needs.set_env.outputs.variables).script-path }}
      import-file: ${{ fromJson(needs.set_env.outputs.variables).import-file }}
      import-collection: ${{ fromJson(needs.set_env.outputs.variables).import-collection }}
    secrets:
      mongo-uri: ${{ secrets.APP_MONGODB_URI }}

  mongo_migrate:
    name: 'Mongo Migrate'
    needs: set_env
    uses: nabarun-ngo/ngo-nabarun-templates/.github/workflows/mongo-cloud.yml@main
    if: ${{ fromJson(needs.set_env.outputs.variables).action == 'migrate' }}
    with:
      target-env: ${{ fromJson(needs.set_env.outputs.variables).target_env }}
      migration-script-path: ${{ fromJson(needs.set_env.outputs.variables).migration-script }}
    secrets:
      mongo-uri: ${{ secrets.APP_MONGODB_URI }}
      postgres-uri: ${{ secrets.APP_POSTGRES_URI }}


  sync_summary:
    name: 'ðŸ“Š Operation Logs'
    runs-on: ubuntu-latest
    needs: [set_env, mongo_data,mongo_migrate]
    if: always()
    steps:
      - name: ðŸ“‹ Generate Report
        id: summary
        run: |
          echo "## ðŸ”„ Operation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… MongoDB Script Execution Log" >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.mongo_data.script-logs }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… MongoDB Data Import Log" >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.mongo_data.import-logs }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
         
          echo "### ðŸ“ Operation Notes" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- Run ID: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
  

name: '[Util] Redis Operations Manager'

on:
  workflow_dispatch:
    inputs:
      operation:
        description: 'Operation to perform'
        required: true
        type: choice
        options:
          - view-keys
          - delete-keys
        default: view-keys
      environment:
        description: 'Environment to operate on'
        required: true
        type: choice
        options:
          - staging
          - prod
        default: staging
      key:
        description: 'Specific Redis key to delete (leave empty to delete all keys - USE WITH CAUTION!)'
        required: false
        type: string
        default: ''

jobs:
  redis-operations:
    name: 'Execute Redis Operation'
    uses: nabarun-ngo/ngo-nabarun-templates/.github/workflows/Redis-Ops.yml@main
    with:
      operation: ${{ inputs.operation }}
      environment: ${{ inputs.environment }}
      key: ${{ inputs.key }}
    secrets:
      redis_host: ${{ secrets.REDIS_HOST }}
      redis_port: ${{ secrets.REDIS_PORT }}
      redis_password: ${{ secrets.REDIS_PASSWORD }}

  display-results:
    name: 'Display Operation Results'
    runs-on: ubuntu-latest
    needs: redis-operations
    if: always()
    steps:
      - name: Generate Results Summary
        run: |
          echo "# 🔴 Redis Operations Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Basic operation info
          echo "## 📋 Operation Details" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Operation** | \`${{ inputs.operation }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`${{ inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Key** | \`${{ inputs.key || 'All keys (FLUSHALL)' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | ${{ needs.redis-operations.result == 'success' && '✅ Success' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Timestamp** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Connection test results
          echo "## 🔗 Connection Test" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ needs.redis-operations.outputs.ping_result }}" ]; then
            echo "${{ needs.redis-operations.outputs.ping_result }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Connection test failed or no result available" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Operation results
          echo "## 📊 Operation Results" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ needs.redis-operations.outputs.operation_result }}" ]; then
            echo "${{ needs.redis-operations.outputs.operation_result }}" >> $GITHUB_STEP_SUMMARY
            
            # Add count information
            if [ -n "${{ needs.redis-operations.outputs.keys_count }}" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              if [ "${{ inputs.operation }}" = "view-keys" ]; then
                echo "**Keys Found:** ${{ needs.redis-operations.outputs.keys_count }}" >> $GITHUB_STEP_SUMMARY
              else
                echo "**Keys Affected:** ${{ needs.redis-operations.outputs.keys_count }}" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          else
            echo "ℹ️ No operation results available" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          if [ "${{ needs.redis-operations.result }}" = "success" ]; then
            echo "## ✅ Operation Completed Successfully" >> $GITHUB_STEP_SUMMARY
            echo "The Redis operation completed without errors." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ❌ Operation Failed" >> $GITHUB_STEP_SUMMARY
            echo "The Redis operation encountered errors. Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
          fi
          
          # Action recommendations
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## 💡 Next Steps" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.operation }}" = "view-keys" ]; then
            if [ "${{ needs.redis-operations.outputs.keys_count }}" = "0" ]; then
              echo "- Redis is clean with no keys present"
            else
              echo "- Consider cleaning up unnecessary keys if needed"
              echo "- Use the 'delete-keys' operation to remove specific keys"
            fi
          else
            echo "- Keys have been deleted from Redis"
            echo "- Verify your application behavior after key deletion"
            echo "- Use 'view-keys' operation to confirm current Redis state"
          fi